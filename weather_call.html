<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Weather in SA</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <link rel="stylesheet" href="CSS/weather_call_css.css">
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.53.0/mapbox-gl.css' rel='stylesheet'/>

</head>
<div class="container-fluid">
<body>
<div class="row border text-center">
    <div class="col-4"></div>
    <div class="col-4 text-center">Weather Map</div>
    <div class="col-4"></div>
</div>
<div class="row border text-center">
    <table class="table">
        <thead>
        <tr>
            <th scope="col" class="border">Today</th>
            <th scope="col" class="border">Tomorrow</th>
            <th scope="col" class="border">TDAT</th>
        </tr>
        <tr id="weather"></tr>
        <tr id="precipitation"></tr>
        <tr id="summary"></tr>
        </thead>
    </table>
</div>
<div id="map"></div>
<pre id="coordinates"></pre>


<script src="js/keys.js"></script>
<script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.53.0/mapbox-gl.js'></script>
<script src="js/mapbox-geocoder-utils.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>

<script>

	// Interactive Map //
	mapboxgl.accessToken = mapboxToken;
	var coordinates = $('#coordinates')
	var options = {
		container: "map",
		style: 'mapbox://styles/mapbox/streets-v9',
		zoom: 10,
		center: [-98.42, 29.42]
	};
	var map = new mapboxgl.Map(options);


	(function () {

		function geocode(search, token) {
			var baseUrl = 'https://api.mapbox.com';
			var endPoint = '/geocoding/v5/mapbox.places/';
			return fetch(baseUrl + endPoint + encodeURIComponent(search) + '.json' + "?" + 'access_token=' + token)
				.then(function (res) {
					console.log(res);
					return res.json();
				})
		}
		geocode("San Francisco", mapboxToken);

		// Weather Info //
		function refreshWeather() {
			$.ajax("https://cors-anywhere.herokuapp.com/https://api.darksky.net/forecast/" + darkSkyToken + "/29.4241,-98.4936").done(function (data, status, jqHxr) {
				console.log(data);
				console.log(status);

				// All the Vars //
				var dateObject = new Date(data.currently.time * 1000);
				var weather = data;
				var currentTemp = parseFloat(weather.currently.temperature).toFixed(1) + '&deg;';
				var currentPrecip = weather.currently.icon.replace("-", " ").replace("-", " ");
				var todaysLow = parseFloat(weather.daily.data[0].apparentTemperatureLow).toFixed(1) + '&deg;';
				var todaysHigh = parseFloat(weather.daily.data[0].apparentTemperatureHigh).toFixed(1) + '&deg;';
				var tomLow = parseFloat(weather.daily.data[1].apparentTemperatureLow).toFixed(1) + '&deg;';
				var tomHigh = parseFloat(weather.daily.data[1].apparentTemperatureHigh).toFixed(1) + '&deg;';
				var tdatLow = parseFloat(weather.daily.data[2].apparentTemperatureLow).toFixed(1) + '&deg;';
				var tdatHigh = parseFloat(weather.daily.data[2].apparentTemperatureHigh).toFixed(1) + '&deg;';
				var todayPrecip = weather.daily.data[0].precipProbability;
				var tomPrecip = weather.daily.data[1].precipProbability;
				var tdatPrecip = weather.daily.data[2].precipProbability;
				var todaySummary = weather.daily.data[0].summary.replace("throughout the day", "").replace(".","");
				var tomSummary = weather.daily.data[1].summary.replace("throughout the day", "").replace(".","");
				var tdatSummary = weather.daily.data[2].summary.replace("throughout the day", "").replace(".","");

				// Temperature Low - High //
				$('#weather').html('');
				$('#weather').append('<th scope="col" class="border align-middle">Low: ' + todaysLow + ' - High: ' + todaysHigh + '<br>Currently: ' + currentTemp + '</th><th scope="col" class="border align-middle">Low: ' + tomLow + ' - High: ' + tomHigh + '</th><th scope="col" class="border align-middle">Low: ' + tdatLow + ' - High: ' + tdatHigh + '</th>');

				// Precipitation //
				$('#precipitation').html('');
				$('#precipitation').append('<th scope="col" class="border align-middle">Chance of Rain: ' + todayPrecip + '% <br> Currently: ' + currentPrecip + '</th><th scope="col" class="border align-middle">Chance of Rain: ' + tomPrecip + '%</th><th scope="col" class="border align-middle">Chance of Rain: ' + tdatPrecip + '%</th>');

				// Summary //
				$('#summary').html('');
				$('#summary').append('<th scope="col" class="border">' + todaySummary + '</th><th scope="col" class="border">' + tomSummary + '</th><th scope="col" class="border">' + tdatSummary + '</th>');
			});
		}

		refreshWeather();
		window.setInterval(function () {
			refreshWeather()
		}, 5000);


    })();

</script>
</body>
</div>
</html>